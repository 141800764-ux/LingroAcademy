<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Dashboard - Lingro Academy</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body{background:linear-gradient(135deg,#1540A6 0%,#3C6EFA 60%,#D4AF37 100%);font-family:'Inter',sans-serif;color:#fff;min-height:100vh;}
.lesson-card{background:rgba(255,255,255,0.15);cursor:pointer;transition:transform 0.2s,box-shadow 0.2s;}
.lesson-card:hover{transform:translateY(-5px);box-shadow:0 8px 20px rgba(0,0,0,0.3);}
video{width:100%;border-radius:15px;margin-top:10px;}
.navbar{background-color:rgba(0,0,0,0.4);}
h2,h3{text-shadow:1px 1px 3px rgba(0,0,0,0.5);}
</style>
</head>
<body>

<nav class="navbar navbar-dark px-4 d-flex align-items-center">
<img src="images/lingroLogo.png" alt="Lingro Academy Logo" style="height:170px;margin-right:15px;">
<span class="navbar-brand">Lingro Academy - Student Dashboard</span>
<button class="btn btn-light ms-auto" onclick="logout()">Logout</button>
</nav>

<div class="container text-center mt-5">
<h2 class="mb-4">Welcome, <span id="studentName"></span></h2>

<h3 class="mb-4">Self-Study Lessons</h3>
<div class="row justify-content-center g-4">
<div class="col-md-3"><div class="card lesson-card p-3" onclick="previewLesson('lessons/lesson1.html')"><h5>Lesson 1</h5><p>Basic English</p></div></div>
<div class="col-md-3"><div class="card lesson-card p-3" onclick="previewLesson('lessons/lesson2.html')"><h5>Lesson 2</h5><p>Grammar Training</p></div></div>
<div class="col-md-3"><div class="card lesson-card p-3" onclick="previewLesson('lessons/lesson3.html')"><h5>Lesson 3</h5><p>Vocabulary</p></div></div>
</div>

<div class="row mt-5 text-center">
<div class="col-md-6"><h4>Student Camera</h4><video id="studentVideo" autoplay muted playsinline></video><button class="btn btn-warning mt-2" id="muteBtn">Mute</button></div>
<div class="col-md-6"><h4>Teacher Camera</h4><video id="teacherVideo" autoplay playsinline></video></div>
<div class="col-md-12 mt-4"><h4>Shared Lesson</h4><video id="lessonVideo" autoplay playsinline></video></div>
</div>
</div>

<div class="modal fade" id="lessonModal" tabindex="-1">
<div class="modal-dialog modal-lg modal-dialog-centered">
<div class="modal-content">
<div class="modal-header bg-primary text-warning"><h5 class="modal-title">Lesson Preview</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
<div class="modal-body"><iframe id="previewIframe" style="width:100%; height:400px; border:none;"></iframe></div>
<div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div>
</div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const student = JSON.parse(localStorage.getItem("loggedInStudent"));
if(student) document.getElementById("studentName").innerText=student.name;

function previewLesson(url){document.getElementById("previewIframe").src=url;new bootstrap.Modal(document.getElementById("lessonModal")).show();}
function logout(){localStorage.removeItem("loggedInStudent");window.location.href="index.html";}

/* ---------- WEBRTC SOCKET.IO ---------- */
const socket = io('http://localhost:3000');
let localStream, peerConnection;
const config={iceServers:[{urls:"stun:stun.l.google.com:19302"}]};
const studentVideo=document.getElementById("studentVideo");
const teacherVideo=document.getElementById("teacherVideo");
const muteBtn=document.getElementById("muteBtn");

socket.on('offer', async offer=>{
    localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    studentVideo.srcObject=localStream;

    peerConnection=new RTCPeerConnection(config);
    localStream.getTracks().forEach(track=>peerConnection.addTrack(track,localStream));
    peerConnection.ontrack=e=>teacherVideo.srcObject=e.streams[0];
    peerConnection.onicecandidate=e=>{if(e.candidate) socket.emit('ice-candidate',e.candidate);};

    await peerConnection.setRemoteDescription(offer);
    const answer=await peerConnection.createAnswer();
    await peerConnection.setLocalDescription(answer);
    socket.emit('answer',answer);
});

socket.on('ice-candidate', async candidate=>{if(peerConnection) await peerConnection.addIceCandidate(candidate);});

// Receive shared lesson from teacher
socket.on('share-lesson', lesson => {
    document.getElementById("lessonVideo").src = lesson;
});

muteBtn.onclick=()=>{localStream.getAudioTracks()[0].enabled=!localStream.getAudioTracks()[0].enabled; muteBtn.innerText=localStream.getAudioTracks()[0].enabled?"Mute":"Unmute";};
</script>
</body>
</html>
